[tools]
flutter = "3.35"
python = "3.13"

[tasks]
bootstrap = { run = [
  "cd backend && uv sync",
  "cd frontend/survivor_pool && flutter pub get",
], description = "Install all project dependencies" }

backend = { run = [
  "uv run uvicorn src.main:app --reload --host 0.0.0.0 --port 8000",
], dir = "backend", env = { _.file = ".env.dev" }, description = "Start backend server" }

frontend = { run = [
  "flutter run -d \"iPhone 17 Pro Max\" --dart-define=API_BASE_URL=http://localhost:8000",
], dir = "frontend/survivor_pool", description = "Start frontend server" }

frontend-prod = { run = [
  "flutter run -d \"iPhone 17 Pro Max\" --dart-define=API_BASE_URL=https://api.survivorpoolapp.com",
], dir = "frontend/survivor_pool", description = "Start frontend server" }

frontend2 = { run = [
  "flutter run -d \"iPhone 17 Pro\" --dart-define=API_BASE_URL=http://localhost:8000",
], dir = "frontend/survivor_pool", description = "Start frontend server" }

web = { run = [
  "flutter run -d web-server --dart-define=API_BASE_URL=http://localhost:8000",
], dir = "frontend/survivor_pool", description = "Start web server" }

ipa = { run = [
  "flutter build ipa --release --obfuscate --split-debug-info=build/ios_split_debug_info --dart-define=API_BASE_URL=https://api.survivorpoolapp.com",
], dir = "frontend/survivor_pool", description = "Build iOS IPA with obfuscation and split debug info" }

mongo = { run = [
  "docker run --rm --name survivor-mongo -d -p 27017:27017 -v dev-mongo-data:/data/db -v dev-mongo-config:/data/configdb mongo:8.0",
], description = "Start MongoDB for development" }

db-update = { run = "./db/update.sh", description = "Copy db/ into Mongo container and run init.js" }

dev = { run = [
  "mise run mongo",
  "if tmux has-session -t survivor-dev 2>/dev/null; then echo \"tmux session survivor-dev already running\"; exit 1; fi",
  "tmux new-session -d -s survivor-dev -n mongosh -c .",
  "tmux send-keys -t survivor-dev:mongosh \"mise run db-update -- --dev && docker exec -it survivor-mongo mongosh survivor_pool\" C-m",
  "tmux new-window -t survivor-dev -n backend -c .",
  "tmux send-keys -t survivor-dev:backend \"mise run backend\" C-m",
  "tmux new-window -t survivor-dev -n frontend -c .",
  "tmux send-keys -t survivor-dev:frontend \"mise run frontend\" C-m",
  "tmux new-window -t survivor-dev -n web -c .",
  "tmux send-keys -t survivor-dev:web \"mise run web\" C-m",
  "echo 'Services running in tmux session survivor-dev. Attach with: mise attach'",
], description = "Start all development services in background" }

stop = { run = [
  "docker compose down 2>/dev/null",
  "tmux send-keys -t survivor-dev:frontend q 2>/dev/null || true; sleep 1",
  "tmux kill-session -t survivor-dev 2>/dev/null || echo \"tmux session survivor-dev not found\"",
  "docker stop survivor-mongo 2>/dev/null || echo 'MongoDB not running'",
  "echo 'All development services stopped'",
], description = "Stop all development services" }

attach = { run = [
  "tmux attach -t survivor-dev",
], description = "Attach to tmux session" }

prod = { run = [
  "docker compose up -d --build",
  "mise run db-update -- --prod",
], description = "Start production services" }

prod-build = { run = [
  "docker build --pull -f frontend/survivor_pool/web/Dockerfile -t survivor-pool-frontend --build-arg API_BASE_URL=https://api.survivorpoolapp.com frontend/survivor_pool",
  "docker build --pull -t survivor-pool-backend backend",
], description = "Build production Docker images for frontend and backend" }

prod-mongo = { run = [
  "docker compose exec -it mongo mongosh --username \"$MONGO_INITDB_ROOT_USERNAME\" --password \"$MONGO_INITDB_ROOT_PASSWORD\" --authenticationDatabase admin mongodb://127.0.0.1:27017/survivor_pool",
], env = { _.file = ".env.prod" }, description = "Open prod mongosh with auth" }
